name: Training Pipeline - Daily

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  train:
    runs-on: ubuntu-22.04

    env:
      MONGODB_URI: ${{ secrets.MONGODB_URI }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Create Virtual Environment
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip

      - name: Install Dependencies
        run: |
          source venv/bin/activate
          pip install --no-cache-dir pandas numpy scikit-learn pymongo
          pip install --no-cache-dir xgboost==1.7.6 lightgbm==4.3.2 || echo "Skipping heavy package install for CI"

      - name: Debug Environment
        run: |
          df -h
          free -h
          source venv/bin/activate
          python -m pip list
          env

      - name: Test MongoDB Connection
        run: |
          source venv/bin/activate
          python - <<EOF
          import os
          from pipelines.mongodb_store import MongoDBStore
          try:
              store = MongoDBStore()
              df = store.get_features()
              print("MongoDB connection successful, fetched rows:", len(df))
          except Exception as e:
              print("MongoDB connection failed:", e)
          EOF

      - name: Run Training Pipeline
        run: |
          source venv/bin/activate
          python - <<EOF
          from pipelines.training_pipeline import TrainingPipeline
          import os

          # Optional: Skip heavy models for CI
          pipeline = TrainingPipeline(train_lightgbm=False, train_xgboost=False)
          pipeline.run()
          EOF